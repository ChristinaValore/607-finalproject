---
title: 'Data 607: Final Project'
author: "Anthony Munoz, Christina Valore, David Apolinar"
date: "5/10/2019"
output: 
  html_document:
    #df_print: paged
    toc: true # table of content true
    toc_collapsed : false
    toc_float: true
    code_folding : show
    toc_depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: true  ## if you want number sections at each table header
    smooth_scroll: true
    theme: cerulean  # many options for theme, this one is my favorite.
    highlight: textmate  # specifies the syntax highlighting style
---

```{r setup, include=FALSE}
library(mongolite)
library(magrittr)
library(dplyr)
library(tidyr)
```

# Project Overview

NYC Subway delays have been constantly scrutinized for being delayed all the time. There are daily articles published criticizing the MTA for not doing enough to resolve the constant delays that plague the 100+ year aging subway system. To make matters worse, there is constant scrutiny over the MTA overpaying its workers and not contributing to repairing its infrastructure.

* https://patch.com/new-york/new-york-city/nyc-subway-delays-8-lines-messed-during-morning-rush
* https://www.cbsnews.com/news/new-york-struggling-transit-agency-mta-paid-one-worker-344k-in-overtime/

As part of this analysis, we want to determine what could be the causes of the NYC Subway system. We gathered data from several locations, including the MTA's own published performance metrics.

# Business Question


As part of this analysis, we want to answer the following questions?

* Is the time of the year predicitive of the NYC subway on-time performance (OTP)?
* Are there other factors contributing to the delays?
  
  * population increases
  * weather impact

Using some of the collected data, we want to detemrine whether there may be external factors that may show some level of correlation with they delays. It's quite possible that it may not be the case, but this is why we analyze the data to come to a conclusion.

# Obtain the Data

Data was obtained from several locations:

* MTA Performance Data

This dataset included the following items:

**Subway**

  *  Subway wait assessment for all lines
  *  Customer Injury Rate
  *  Elevator availability
  *  Escalator Availability
  *  Mean Distance Between Failure
  *  On-Time Performance, total and for all lines
  *  Total Ridership

http://web.mta.info/developers/performance.html

**Average Monthly and Annual Temperates at Centrak Park, NY**

This data set includes all monthly averages from 1869 to 2018

https://www.weather.gov/media/okx/Climate/CentralPark/monthlyannualtemp.pdf

**Projected Population Data**

While there is no accurate source of population per year, we based our population data from the 2010 census with projections built-in for each year.

http://worldpopulationreview.com/us-cities/new-york-city-population


### Subway Data Processing


```{r MTA}
# load data
data<- read.csv("https://raw.githubusercontent.com/ChristinaValore/stats-prob-606/master/Performance_NYCT.csv", header=TRUE, check.names = FALSE)

# subsetting the data to only pull out the OTP (ON TIME %) and total ridership
sub <-data[ which(data$PARENT_SEQ=='391690'| data$INDICATOR_SEQ=='103929'), ]

head(otp,10)

# remove columns that are not needed for this analysis
sub<- sub[c(-3, -5:-10)]

# check for the completeness of the data by checking how many subways were analyzed
unique(sub$INDICATOR_NAME)

# 24 subways were analyzed over 12 months so each year should have 288 values
table(sub$PERIOD_YEAR) 

# See if OTP was measured for all subway lines
table(sub$INDICATOR_NAME)

# we would like the data to be as similar as possible so we will remove the years 2009 and 2010 as they have the least data and standardize the remainder of the years be removing incomplete subway lines: S line 42 and the W line
sub.updated<-sub %>% 
  filter(PERIOD_YEAR >= "2011", INDICATOR_NAME != "OTP (Terminal) - W Line", INDICATOR_NAME != "OTP (Terminal) - S Line 42 St.")

# check on the data once more for completeness
table(otp.updated$PERIOD_YEAR) 
table(otp.updated$PERIOD_MONTH) 

```

## Weather Data Processing

To process the weather data, we decided to convert to a CSV and store it directly on a MongoDB instance running in Microsoft Azure. This made it easy to filter based on the year using the following query:

* weather.2017<-mgo$find('{"YEAR":{"$gt":2007}}')

The resulting values were stored into a dataframe and then converted from wide to long format using tidyverse gather

```{r mongo}
#file.old <- "/Users/davidapolinar/Dropbox/CUNYProjects/Srping2019/Data607/FinalProject/monthlyannualtemp-converted.csv"
file <- "https://raw.githubusercontent.com/dapolloxp/607-finalproject/master/monthlyannualtemp-converted.csv"

weather.data = read.csv(file, stringsAsFactors = FALSE)
cleaned.weather <- weather.data %>% select(-11)
missing.days <- c(77.5, 76, 68.5, 57.5, 47.5, 38)
cleaned.weather[150,8:13] <- missing.days
cleaned.weather[150,14] <- apply(cleaned.weather[10,2:13],1,mean)

mongo_pwd_file <- "/Users/christinavalore/Desktop/password.txt"

mongo_password <-read.delim(mongo_pwd_file, header = FALSE, stringsAsFactors = FALSE)

url <- paste0("mongodb://nyc.admin:", mongo_password$V1 , "@52.167.52.62:27017/weather",sep = "")

mgo <- mongo(collection = "nyc", db = "weather",  url=url, verbose = TRUE)
mgo$drop()
mgo$insert(cleaned.weather)

weather.2017<-mgo$find('{"YEAR":{"$gt":2007}}')

mgo$find('{"YEAR":{}}')
```

```{r}
weather.2017.cleaned <- weather.2017 %>% select(-ANNUAL)
new <- gather(weather.2017.cleaned , 'JAN', 'FEB', 'MAR', 'APR','MAY','JUN','JUL','AUG', 'SEP','OCT','NOV','DEC',key = 'Month', value = 'Avg Monthly Temp')
```

**Before Converting the data from wide to long:**



```{r}
weather.2017
```

**After the conversion:**

```{r}
head(new %>% arrange(YEAR),n=20)

new [new== "JAN"]<-1
new [new== "FEB"]<-2
new [new== "MAR"]<-3
new [new== "APR"]<-4
new [new== "MAY"]<-5
new [new== "JUN"]<-6
new [new== "JUL"]<-7
new [new== "AUG"]<-8
new [new== "SEP"]<-9
new [new== "OCT"]<-10
new [new== "NOV"]<-11
new [new== "DEC"]<-12

new<-new %>%
  rename(
    PERIOD_YEAR = YEAR,
   PERIOD_MONTH = Month
  )

new$PERIOD_MONTH<- as.character(new$PERIOD_MONTH)

new.weather<-new %>% 
  filter(PERIOD_YEAR >= "2011" & PERIOD_YEAR <="2017")
```
## Population Data Processing

The data was retrieved from the following web link: 

http://worldpopulationreview.com/us-cities/new-york-city-population

To process this data, we had to use the RVest libraries to process the HTML tables. This made the processing extremely simple. While RVest gathered all tables, we were able to filter the rows that we are interested in:



```{r population}
library(rvest)
population.data <- read_html("http://worldpopulationreview.com/us-cities/new-york-city-population")
pop.table <-population.data %>% html_nodes("table") %>% .[[1]] %>% html_table()
expected.growth <-pop.table[2:9,1:2]
names(expected.growth) <- pop.table[1,1:2]

expected.growth

```

# Cleansing

```{r}
## Once we have all the data - we can attempt to combine all a do a futher cleansing process as needed.

combined<-left_join(sub.updated, new.weather, by= c("PERIOD_YEAR", "PERIOD_MONTH"))

#rename avg monthly temp column to conform to caps standards
combined<-combined %>%
  rename(
 MONTHLY_TEMP=`Avg Monthly Temp`
  )

# decide what variable types need to be changed 
str(combined)

# change year/month to factors as no mathematical operations will be performed
combined$PERIOD_YEAR<- as.factor(combined$PERIOD_YEAR)
combined$PERIOD_MONTH<- as.factor(combined$PERIOD_MONTH)

otp_df<- subset(combined, PARENT_SEQ=='391690')
rider_df <- subset(combined, INDICATOR_NAME=="Total Ridership - Subways")

# aggregate OTP & Weather by month
agg_otp<- aggregate(list(MONTHLY_OTP=otp_df$MONTHLY_ACTUAL,MONTHLY_TEMP=otp_df$MONTHLY_TEMP), by= list(MONTH=otp_df$PERIOD_MONTH), FUN=mean)

# aggregate ridership by month
agg_ride<- aggregate(list(MONTHLY_RIDERSHIP=rider_df$MONTHLY_ACTUAL), by= list(MONTH=rider_df$PERIOD_MONTH), FUN=mean)

agg.combined<-left_join(agg_otp, agg_ride, by= c("MONTH"))

```


# Exploration

```{r ggplot}
library(ggplot2)
library(ggthemes)

# scatter plot 
scatter.smooth(x=agg.combined$MONTHLY_TEMP, y=agg.combined$MONTHLY_OTP)

# boxplot to see outliers
par(mfrow=c(1, 2))  # divide graph area in 2 columns
boxplot(agg.combined$MONTHLY_OTP,sub=paste("Outlier rows: ", boxplot.stats(agg.combined$MONTHLY_OTP)$out))  
boxplot(agg.combined$MONTHLY_TEMP, sub=paste("Outlier rows: ", boxplot.stats(agg.combined$MONTHLY_TEMP)$out))  

# density plot 
library(e1071)
par(mfrow=c(1, 2))  # divide graph area in 2 columns

plot(density(agg.combined$MONTHLY_OTP), main="Density Plot: Monthly OTP", ylab="Frequency", sub=paste("Skewness:", round(e1071::skewness(agg.combined$MONTHLY_OTP), 3)))  
polygon(density(agg.combined$MONTHLY_OTP), col="red")

plot(density(agg.combined$MONTHLY_TEMP), main="Density Plot: Monthly Temp", ylab="Frequency", sub=paste("Skewness:", round(e1071::skewness(agg.combined$MONTHLY_TEMP), 3)))  
polygon(density(agg.combined$MONTHLY_TEMP), col="red")

# the correlation is weak between the monthly subway OTP and the monthly temp at 21%
cor(agg.combined$MONTHLY_OTP,agg.combined$MONTHLY_TEMP)

# the correlation is weak between the monthly ridership and the OTP at 11%
cor(agg.combined$MONTHLY_OTP, agg.combined$MONTHLY_RIDERSHIP)

# the correlation is better between temperature and ridershop at 33%
cor(agg.combined$MONTHLY_RIDERSHIP, agg.combined$MONTHLY_TEMP)



```

# Modeling 
```{r}

#OTP = month + weather + ridership

# ANOVA
fit <- lm(MONTHLY_RIDERSHIP ~ MONTHLY_TEMP, data=agg.combined)
summary(fit) 
plot(fit)

fit2<- lm(MONTHLY_OTP ~ MONTHLY_TEMP, data=agg.combined)
summary(fit2) 
plot(fit2)

fit3<- lm(MONTHLY_OTP ~ MONTHLY_TEMP + MONTHLY_RIDERSHIP, data=agg.combined)
summary(fit3) 
plot(fit3)

library (betareg)

```


# Interpretation

Is weather a predictor of the NYC subway's on time percentage (OTP)?


# Conclusion